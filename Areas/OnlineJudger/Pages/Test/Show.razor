@page "/online-judger/tests/show/{id}"
@inject IMatToaster Toaster
@using TeachingSystem.Areas.OnlineJudger.Shared
@if (name != null){
<h1>考试：@name </h1>
<h4>本测试允许1次尝试</h4>
<h4>本测试可保存并随时继续，直到时间结束</h4>
}
@if (course != null){
<h4>科目：@course</h4>
}
@if (start_time != null){
<h4>时间：@start_time - @end_time</h4>
}

@if (testPaper != null)
{
    num = 1;
    @foreach(Question question in question_list)
    {
        var localnum = num;
        switch(question.Type){
            case "TrueOrFalse":
                <MatRadioGroup @bind-Value="@ValTF" TValue="string">
                    <div> @localnum: @question.Content </div>
                    <div ><MatRadioButton Value="@("True")" TValue="string">True</MatRadioButton></div>
                    <div ><MatRadioButton Value="@("False")" TValue="string">False </MatRadioButton></div>
                </MatRadioGroup>
                QA_temp.Add(question.QuestionId,ValTF);
            break;
            case "SingleChoice":
                <MatRadioGroup @bind-Value="@ValSC" TValue="string">
                    <div> @localnum @question.Content (Single Choice) </div>
                    <div><MatRadioButton Value="@("A")" TValue="string">A. @question.ChoiceA</MatRadioButton></div>
                    <div><MatRadioButton Value="@("B")" TValue="string">B. @question.ChoiceB</MatRadioButton></div>
                    <div><MatRadioButton Value="@("C")" TValue="string">C. @question.ChoiceC</MatRadioButton></div>
                    <div><MatRadioButton Value="@("D")" TValue="string">D. @question.ChoiceD</MatRadioButton></div>
                </MatRadioGroup>
                QA_temp.Add(question.QuestionId,ValSC);
            break;
            case "MultipleChoice":
               
                <div> @localnum: @question.Content (Multiple Choice) </div>
                <div><MatCheckbox @bind-Value="@ValA">A. @question.ChoiceA</MatCheckbox></div>
                <div><MatCheckbox @bind-Value="@ValB">B. @question.ChoiceB</MatCheckbox></div>
                <div><MatCheckbox @bind-Value="@ValC">C. @question.ChoiceC</MatCheckbox></div>
                <div><MatCheckbox @bind-Value="@ValD">D. @question.ChoiceD</MatCheckbox></div>
                
               ValMC = "";
               if(ValA) ValMC +="A";
               if(ValB) ValMC +="B";
               if(ValC) ValMC +="C";
               if(ValD) ValMC +="D";
               //貌似用这种方式不行
                QA_temp.Add(question.QuestionId,ValMC);
                
                break; 
        }
        num = num + 1;   
    }
  <MatButton OnClick="@(_ => {NavigationManager.NavigateTo("/online-judger/test-papers");})" Label="Back"></MatButton>
  <MatButton OnClick="@SaveResult" Label="Save"></MatButton>

}
else{
    <h4>所绑定的Test Paper Id不在数据库中</h4>
}

@code {

    [Parameter]
    public bool admin {get;set;} = false;

    [Parameter]
    public string id {get;set;}
    public string end_time {get;set;}
    public string start_time{get;set;}
    public string TestPaperid {get;set;}
    public int num {get;set;}
    public string ValTF{get;set;}
    public string ValSC{get;set;}
    public string ValMC{get;set;}
    public bool  ValA{get;set;}
    public bool  ValB{get;set;}
    public bool  ValC{get;set;}
    public bool  ValD{get;set;}
    public string course{get;set;}
    public string name{get;set;}
    [Parameter]
    public Action OnSave {get;set;}
    public Dictionary<string, string> QA_temp = new Dictionary<string, string>();
    TestPaper testPaper;
    Test test;
    List<Question> question_list = new List<Question>();
    //按 Save之后存到数据库
    async Task SaveResult() 
    {
       // TestResult testResult = new TestResult();
       // testResult.TestId = id;
      //  testResult.StudentId = null;
      //  testResult.QA = QA_temp;

      //  await DbContext.TestResults.AddAsync(testResult);
      //  await DbContext.SaveChangesAsync();
        
        NavigationManager.NavigateTo("/online-judger/test-papers");
    }

    protected override async Task OnInitializedAsync() 
    {
        
        test = await  DbContext.Tests.SingleAsync(c => c.TestId == id);
        testPaper = await  DbContext.TestPapers.SingleAsync(c => c.TestPaperId == test.TestPaperId);
        course = test.className;
        name = test.Name;
        start_time = test.start_time;
        end_time = test.end_time;
        if (testPaper != null)
        {
            foreach(String id in testPaper.Content){
               question_list.Add(await DbContext.Questions.SingleAsync(c => c.QuestionId == id));
            }
        }
    }
} 
